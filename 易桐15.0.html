<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜“æ¡ç”µç«ï¼šèŒç³»ä¸‰è§’æ´²è¡ŒåŠ¨</title>
    <style>
        /* === å¯çˆ±é£è§†è§‰æ ¸å¿ƒ (Cute Core v14) === */
        :root {
            --c-bg: #fff0f6; /* æ¨±èŠ±ç²‰èƒŒæ™¯ */
            --c-panel: #ffffff; /* çº¯ç™½é¢æ¿ */
            --c-accent: #ffd700; /* å¥¶é…ªé»„ (äº’åŠ¨) */
            --c-primary: #88d8b0; /* è–„è·ç»¿ (å‰è¿›) */
            --c-danger: #ff9a9e;  /* è‰è“çº¢ (åé€€/å“ç‰Œè‰²) */
            --c-text: #555555;    /* æŸ”å’Œç°å­— */
            --c-text-light: #999999;
            --font-cute: 'Comic Sans MS', 'å¹¼åœ†', 'Rounded Mplus 1c', sans-serif;
            --node-size: 75px;
            --border-radius-l: 35px;
            --border-radius-m: 20px;
            --shadow-soft: 0 8px 20px rgba(255, 182, 193, 0.3);
            --shadow-button: 0 6px 0 rgba(0,0,0,0.1);
        }

        body {
            background-color: var(--c-bg);
            /* å¯çˆ±æ³¢ç‚¹èƒŒæ™¯ */
            background-image: 
                radial-gradient(var(--c-primary) 15%, transparent 15%),
                radial-gradient(var(--c-danger) 15%, transparent 15%);
            background-position: 0 0, 30px 30px;
            background-size: 60px 60px;
            color: var(--c-text);
            font-family: var(--font-cute);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* === 1. é¡¶éƒ¨ HUD === */
        .hud {
            height: 70px;
            background: var(--c-panel);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
            z-index: 100;
            border-bottom: 4px solid #ffe4e1;
            border-radius: 0 0 var(--border-radius-l) var(--border-radius-l);
            box-shadow: var(--shadow-soft);
        }

        .hud-left { display: flex; align-items: center; gap: 10px; }
        .role-avatar { 
            width: 45px; height: 45px; border-radius: 50%; background: #f0f8ff; border: 3px solid var(--c-primary);
            display: flex; justify-content: center; align-items: center; font-size: 26px;
            box-shadow: var(--shadow-button);
        }
        .role-name { font-size: 16px; font-weight: bold; color: var(--c-primary); }

        .progress-box { 
            background: #fffbea; border: 3px solid var(--c-accent); padding: 8px 15px; border-radius: var(--border-radius-m);
            display: flex; align-items: baseline; gap: 5px; box-shadow: var(--shadow-button);
        }
        .progress-label { font-size: 12px; color: var(--c-text-light); }
        .progress-val { font-size: 20px; font-weight: 900; color: var(--c-accent); }
        .progress-val span { font-size: 12px; }

        /* === 2. å…¨å±åœ°å›¾è§†çª— === */
        .viewport {
            flex: 1;
            position: relative;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        .map-container {
            position: absolute; width: 100%; height: 100%;
        }

        /* æ–°å¢ï¼šä¸­å¿ƒå“ç‰Œæ ‡è¯† */
        .center-brand {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 0; /* åœ¨æ ¼å­åé¢ */
            text-align: center;
            background: rgba(255,255,255,0.85);
            padding: 25px 35px; border-radius: 50%;
            border: 5px dashed #ffd1dc;
            box-shadow: 0 5px 25px rgba(255, 182, 193, 0.4);
            backdrop-filter: blur(5px);
        }
        .center-brand h1 {
            margin: 0; font-size: 28px; font-weight: 900; color: var(--c-danger);
            text-shadow: 2px 2px 0 #fff, 3px 3px 0 #ffe4e1;
            letter-spacing: 2px;
        }
        .center-brand p {
            margin: 8px 0 0; font-size: 12px; color: var(--c-primary); letter-spacing: 1px;
            background: #f0fff0; padding: 4px 10px; border-radius: 15px; display: inline-block;
        }

        /* åœ°å›¾èŠ‚ç‚¹ */
        .map-node {
            position: absolute; top: 50%; left: 50%;
            width: var(--node-size); height: var(--node-size);
            display: flex; justify-content: center; align-items: center;
            z-index: 2;
        }

        .node-card {
            width: 100%; height: 100%;
            background: #ffffff;
            border: 4px solid #ffe4e1;
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 0 #ffb6c1, var(--shadow-soft);
            position: relative;
        }
        
        .map-node.active .node-card {
            transform: scale(1.25) translateY(-10px);
            z-index: 10;
            border-color: var(--c-accent);
            box-shadow: 0 10px 0 var(--c-accent), 0 20px 30px rgba(255, 215, 0, 0.4);
        }

        .node-card[data-type="good"] { border-color: var(--c-primary); box-shadow: 0 6px 0 var(--c-primary); }
        .node-card[data-type="bad"] { border-color: var(--c-danger); box-shadow: 0 6px 0 var(--c-danger); }
        .node-card[data-type="party"] { border-color: var(--c-accent); box-shadow: 0 6px 0 var(--c-accent); }
        .node-card[data-type="stop"] { border-color: #ccc; box-shadow: 0 6px 0 #999; }
        .node-card[data-type="start"], .node-card[data-type="end"] { border: 4px dashed var(--c-text-light); background: #f9f9f9; box-shadow: none;}

        .node-icon { font-size: 32px; }
        
        .node-text { display: none; }
        .map-node.active .node-text {
            display: block; position: absolute; top: -100px; left: 50%; transform: translateX(-50%);
            background: #fff; padding: 15px; border-radius: 25px;
            border: 4px solid var(--c-accent);
            width: 200px; text-align: center; pointer-events: none;
            box-shadow: var(--shadow-soft);
            animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .node-text::after {
            content: ''; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%);
            border-width: 15px 15px 0; border-style: solid; border-color: var(--c-accent) transparent transparent;
        }
        @keyframes popUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }

        .node-text h4 { margin: 0; font-size: 16px; color: var(--c-accent); font-weight: bold; }
        .node-text p { margin: 8px 0 0; font-size: 13px; color: var(--c-text); line-height: 1.4; }
        .node-idx { position: absolute; bottom: -25px; font-size: 12px; color: #ffb6c1; font-weight:bold; background:#fff; padding:2px 8px; border-radius:10px; }

        /* ç©å®¶æ ‡è®° */
        .player-token {
            position: absolute; top: 50%; left: 50%; width: 80px; height: 80px;
            z-index: 50; display: flex; justify-content: center; align-items: center; font-size: 50px;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2));
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: bouncePlayer 1.5s infinite alternate ease-in-out;
        }
        @keyframes bouncePlayer { from { transform: translateY(0); } to { transform: translateY(-15px) rotate(5deg); } }

        /* === 3. ä¸­å¤®æ’­æŠ¥ä¸äº’åŠ¨å±‚ === */
        .broadcast-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 240, 245, 0.8);
            z-index: 500; display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s;
        }
        .broadcast-layer.show { display: flex; opacity: 1; }

        .alert-box {
            width: 85%; max-width: 380px; background: #fff;
            border: 5px solid; border-radius: 40px; padding: 30px; text-align: center;
            box-shadow: 0 20px 40px rgba(255, 139, 148, 0.4);
            transform: scale(0.8) rotate(-3deg); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .broadcast-layer.show .alert-box { transform: scale(1) rotate(0deg); }

        .alert-box[data-theme="good"] { border-color: var(--c-primary); background: #f0fff0; }
        .alert-box[data-theme="bad"] { border-color: var(--c-danger); background: #fff0f0; }
        .alert-box[data-theme="party"] { border-color: var(--c-accent); background: #fffef0; }
        .alert-box[data-theme="stop"] { border-color: #ccc; background: #f9f9f9; }

        .alert-icon { font-size: 80px; margin-bottom: 10px; display: block; animation: jelly 1s infinite; }
        @keyframes jelly { 0%,100% { transform: scale(1, 1); } 25% { transform: scale(0.9, 1.1); } 50% { transform: scale(1.1, 0.9); } 75% { transform: scale(0.95, 1.05); } }

        .alert-title { font-size: 24px; font-weight: 900; margin-bottom: 10px; color: inherit; }
        .alert-desc { font-size: 16px; color: var(--c-text); line-height: 1.6; margin-bottom: 30px; }

        .btn-group { display: flex; gap: 15px; justify-content: center; }
        .btn {
            flex: 1; padding: 15px; border: none; font-weight: bold; font-size: 16px; cursor: pointer;
            transition: 0.2s; border-radius: 25px; box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            font-family: var(--font-cute); color: #fff;
        }
        .btn:active { transform: translateY(6px); box-shadow: none; }
        .btn-primary { background: var(--c-primary); }
        .btn-danger { background: var(--c-danger); }
        .btn-outline { background: #fff; border: 3px solid #ccc; color: #999; box-shadow: none; }

        /* === 4. åº•éƒ¨æ§åˆ¶ === */
        .controls {
            height: 120px; background: var(--c-panel);
            border-radius: var(--border-radius-l) var(--border-radius-l) 0 0;
            border-top: 4px solid #ffe4e1;
            display: flex; align-items: center; justify-content: center;
            z-index: 100; box-shadow: 0 -5px 15px rgba(255, 182, 193, 0.3);
        }

        #roll-btn {
            width: 200px; height: 70px; border-radius: 35px;
            background: linear-gradient(90deg, #ff9a9e 0%, #fad0c4 100%);
            border: 4px solid #fff; color: #fff; font-weight: 900; font-size: 24px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(255, 154, 158, 0.4), inset 0 5px 10px rgba(255,255,255,0.5);
            transition: transform 0.1s; font-family: var(--font-cute); letter-spacing: 2px;
        }
        #roll-btn:active { transform: scale(0.95) translateY(5px); }
        #roll-btn:disabled { filter: grayscale(0.5); cursor: not-allowed; background: #ccc; box-shadow: none; color: #666; }

        /* === é€‰äººç•Œé¢ === */
        #char-select {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 245, 250, 0.98); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .char-title-box { text-align: center; margin-bottom: 40px; }
        .char-title-box h2 { font-size: 32px; color: var(--c-danger); margin: 0; text-shadow: 2px 2px 0 #fff; }
        .char-title-box p { color: var(--c-primary); margin-top: 10px; font-size: 14px; background: #e0f7fa; padding: 5px 15px; border-radius: 15px;}

        .char-grid { display: flex; gap: 25px; }
        .char-opt {
            width: 150px; padding: 25px; background: #fff; border: 4px solid #ffe4e1;
            text-align: center; cursor: pointer; border-radius: 35px;
            box-shadow: var(--shadow-soft); transition: all 0.3s;
        }
        .char-opt:hover { border-color: var(--c-accent); transform: translateY(-15px) rotate(2deg); background: #fffbea; }
        
        .char-icon-big { font-size: 60px; margin: 10px 0; filter: drop-shadow(0 5px 0 rgba(0,0,0,0.1)); }
        .char-opt h3 { color: var(--c-text); margin: 10px 0; font-size: 18px; }
        .char-desc { font-size: 13px; color: var(--c-text-light); margin-top: auto; background: #f9f9f9; padding: 10px; border-radius: 15px; line-height: 1.4; }

    </style>
</head>
<body>

    <div id="char-select">
        <div class="char-title-box">
            <h2>æ˜“æ¡ç”µç«Â·ä¸‰è§’æ´²è¡ŒåŠ¨</h2>
            <p>âœ¨ Powered by AI Model & Nano Banana Core âœ¨</p>
        </div>
        <div class="char-grid">
            <div class="char-opt" onclick="game.start('kai')">
                <div class="char-icon-big">âš”ï¸</div>
                <h3>å‡¯Â·æ´› (Kai)</h3>
                <div class="char-desc">ã€æˆ˜æœ¯æœºåŠ¨ã€‘<br>çªå‡»å…µä»”å¤©èµ‹ï¼šæ·å‡º 6 ç‚¹æ—¶ï¼Œå¯ä»¥å¼€å¿ƒå¾—å†åŠ¨ä¸€æ¬¡å“¦ï¼</div>
            </div>
            <div class="char-opt" onclick="game.start('roy')">
                <div class="char-icon-big">ğŸ’‰</div>
                <h3>ç½—ä¼Š (Roy)</h3>
                <div class="char-desc">ã€æˆ˜åœºæ€¥æ•‘ã€‘<br>æ”¯æ´å…µæš–ç”·å¤©èµ‹ï¼šé‡åˆ°åé€€äº‹ä»¶æ—¶ï¼Œåé€€æ­¥æ•°å‡åŠå‘¢ã€‚</div>
            </div>
            <div class="char-opt" onclick="game.start('luna')">
                <div class="char-icon-big">ğŸ¹</div>
                <h3>éœ²å¨œ (Luna)</h3>
                <div class="char-desc">ã€ä¾¦å¯ŸæŒ‡å¼•ã€‘<br>ä¾¦å¯Ÿå…µå¦¹å­å¤©èµ‹ï¼šäº’åŠ¨æŒ‘æˆ˜å¤±è´¥ä¹Ÿä¸ç”¨åé€€å•¦ï¼</div>
            </div>
        </div>
    </div>

    <div class="hud">
        <div class="hud-left">
            <div class="role-avatar" id="role-icon">?</div>
            <span class="role-name" id="role-name">å¹²å‘˜</span>
        </div>
        <div class="progress-box">
            <div class="progress-label">è·ç¦»æ’¤ç¦»ç‚¹</div>
            <div class="progress-val" id="dist-display">0<span> M</span></div>
        </div>
    </div>

    <div class="viewport">
        <div class="map-container" id="map-container">
            <div class="center-brand">
                <h1>æ˜“æ¡ç”µç«</h1>
                <p>Cute Delta Ops</p>
            </div>
            <div id="map-nodes-layer"></div>
            <div class="player-token" id="player">ğŸ‘¶</div>
        </div>
    </div>

    <div class="controls">
        <button id="roll-btn" onclick="game.roll()">å‡ºå‘é¸­!</button>
    </div>

    <div class="broadcast-layer" id="alert-layer">
        <div class="alert-box" id="alert-box">
            <div class="alert-icon" id="a-icon">ğŸ¤</div>
            <div class="alert-title" id="a-title">CHALLENGE</div>
            <div class="alert-desc" id="a-desc">...</div>
            <div class="btn-group" id="a-btns"></div>
        </div>
    </div>

    <script>
        const MAP_STEPS = 24; 
        
        // çœŸäººäº’åŠ¨æŒ‘æˆ˜åº“ (å¤§å¹…æ‰©å®¹!)
        const CHALLENGES = [
            { text: "é€šè®¯æµ‹è¯•ï¼šå¤§å£°å”±ä¸€æ®µ 20 ç§’ä»¥ä¸Šçš„å¯çˆ±æ­Œæ›²ï¼ˆæ¯”å¦‚å­¦çŒ«å«ï¼‰ğŸµ", reward: 3, fail: -2 },
            { text: "ä½“èƒ½ç›‘æµ‹ï¼šåŸåœ°å®Œæˆ 5 ä¸ªèŒèŒçš„æ·±è¹²ï¼Œå–Šä¸€å£°â€˜å¥¥åˆ©ç»™ï¼â€™ğŸ“¸", reward: 2, fail: -1 },
            { text: "ä¿¡ä»»è¿æ¥ï¼šå¤¸å¤¸ç¦»ä½ æœ€è¿‘çš„æˆ˜å‹ï¼ˆè¦çœŸè¯šåœ°è¯´å‡º3ä¸ªä¼˜ç‚¹å“¦ï¼‰ğŸ’–", reward: 4, fail: -3 },
            { text: "é™é»˜éšè”½ï¼šåšä¸€ä¸ªå¯çˆ±çš„é¬¼è„¸ä¿æŒä¸åŠ¨ï¼Œç›´åˆ°ä¸‹å›åˆå¼€å§‹ğŸ¤ª", reward: 2, fail: -1 },
            { text: "æˆ˜åœºç¯å¢ƒæ¨¡æ‹Ÿï¼šæ¨¡ä»¿ä¸‰ç§ä¸åŒçš„å°åŠ¨ç‰©å«å£°ï¼ˆæ¯”å¦‚å–µå–µã€æ±ªæ±ªã€å’©å’©ï¼‰ğŸ¶", reward: 3, fail: -2 },
            { text: "æƒ…æŠ¥å…±äº«ï¼šç»™å¤§å®¶çœ‹çœ‹ä½ æ‰‹æœºç›¸å†Œé‡Œæœ€è¿‘ä¸€å¼ ç¾é£Ÿçš„ç…§ç‰‡ğŸ°", reward: 2, fail: -1 },
            { text: "å…¨å‘˜å¹¿æ’­ï¼šå¤§å–Šä¸‰å£°â€˜æ˜“æ¡ç”µç«ï¼ŒYYDSï¼â€™ğŸ“¢", reward: 3, fail: -1 },
            // æ–°å¢æŒ‘æˆ˜
            { text: "æ‰è‰ºå±•ç¤ºï¼šæ·±æƒ…æœ—è¯µä¸€æ®µç¦»ä½ æœ€è¿‘çš„ç‰©å“ä¸Šçš„æ–‡å­—è¯´æ˜ï¼ˆæ¯”å¦‚é›¶é£Ÿè¢‹ï¼‰ğŸ“–", reward: 3, fail: -2 },
            { text: "æ¨¡ä»¿ç§€ï¼šæ¨¡ä»¿ä¸€ä¸ªä½ æœ€å–œæ¬¢çš„è¡¨æƒ…åŒ…åŠ¨ä½œä¿æŒ 10 ç§’ğŸ¤ª", reward: 2, fail: -1 },
            { text: "æ–¹è¨€æŒ‘æˆ˜ï¼šç”¨ä¸¤ç§ä¸åŒçš„æ–¹è¨€æˆ–å£éŸ³è¯´â€˜è¿™æŠŠç¨³äº†â€™ğŸ—£ï¸", reward: 3, fail: -2 },
            { text: "çœŸå¿ƒè¯ï¼šåˆ†äº«ä¸€ä»¶ä½ æœ€è¿‘å‘ç”Ÿçš„ç³—äº‹ğŸ™ˆ", reward: 4, fail: -2 },
            { text: "å¤§å†’é™©ï¼šå‘é€šè®¯å½•é‡Œç¬¬ä¸€ä½åŒæ€§å¥½å‹å‘é€â€˜æˆ‘å¥½æƒ³ä½ â€™ï¼ˆ3åˆ†é’Ÿåå¯æ’¤å›ï¼‰ğŸ“±", reward: 5, fail: -4 },
            { text: "å¹³è¡¡æµ‹è¯•ï¼šå•è„šç«™ç«‹ä¿æŒå¹³è¡¡ 20 ç§’ğŸ¦©", reward: 2, fail: -1 },
            { text: "ååº”æµ‹è¯•ï¼šå¿«é€Ÿè¯´å‡º 5 ä¸ªå¸¦æœ‰â€˜çº¢â€™å­—çš„ä¸œè¥¿ğŸ", reward: 3, fail: -2 },
            { text: "å›¢é˜Ÿåä½œï¼šå’Œç¦»ä½ æœ€è¿‘çš„äººæ¯”ä¸€ä¸ªå¤§å¤§çš„çˆ±å¿ƒæ‰‹åŠ¿ğŸ«¶", reward: 2, fail: -1 }
        ];

        // äº‹ä»¶åº“ (èŒåŒ–ä¸‰è§’æ´²èƒŒæ™¯æ–‡æ¡ˆ)
        const EVENTS = [
            // å‰è¿› (Good - è–„è·ç»¿)
            { type: 'good', icon: 'ğŸšœ', title: 'å‘¼å«è£…ç”²è½¦å®å®', desc: 'æ­ä¸Šé¡ºé£è½¦å¿«é€Ÿç©¿è¶Šå±é™©åŒºåŸŸï¼Œæ¨è¿› 3 æ ¼ï¼beep beep!', move: 3 },
            { type: 'good', icon: 'ğŸ’‰', title: 'ä½¿ç”¨æ¿€ç´ æª', desc: 'ç»™è‡ªå·±æ‰“äº†ä¸€é’ˆå¼ºåŒ–å‰‚ï¼Œæ„Ÿè§‰å……æ»¡äº†åŠ›é‡ï¼æ¨è¿› 2 æ ¼ã€‚', move: 2 },
            { type: 'good', icon: 'ğŸ', title: 'å‘ç°ç‰©èµ„ç®±âœ¨', desc: 'åœ¨çƒ½ç«åœ°å¸¦æ‰¾åˆ°äº†äº®æ™¶æ™¶çš„æ›¼å¾·å°”ç –çº¿ç´¢ï¼Œæ¨è¿› 1 æ ¼ã€‚', move: 1 },
            // åé€€ (Bad - è‰è“çº¢)
            { type: 'bad', icon: 'ğŸ¤–', title: 'å“å‘€ï¼æ˜¯AIæ¸¸è¡è€…', desc: 'è¢«æ°”å‘¼å‘¼çš„AIå‘ç°äº†ï¼Œå“å¾—èµ¶ç´§åæ’¤ 3 æ ¼èº²èµ·æ¥ã€‚', move: -3 },
            { type: 'bad', icon: 'ğŸ’¨', title: 'è¯¯å…¥æ¯’æ°”åŒº', desc: 'å’³å’³å’³ï¼é˜²æ¯’é¢å…·æ¼æ°”å•¦ï¼Œç´§æ€¥åé€€ 2 æ ¼é€é€æ°”ã€‚', move: -2 },
            { type: 'bad', icon: 'ğŸ’£', title: 'è¸©åˆ°é˜”å‰‘åœ°é›·å•¦', desc: 'å˜­ï¼è¢«ç‚¸å¾—ç°å¤´åœŸè„¸ï¼Œæ™•ä¹ä¹åœ°åé€€ 1 æ ¼ã€‚', move: -1 },
            // æš‚åœ (Stop - ç°è‰²)
            { type: 'stop', icon: 'ğŸ’«', title: 'è¢«éœ‡æ…‘å¼¹å‘½ä¸­', desc: 'çœ¼å‰å…¨æ˜¯å°æ˜Ÿæ˜Ÿâœ¨ï¼Œè¢«èŒæ™•äº†ï¼Œä¸‹å›åˆæš‚åœè¡ŒåŠ¨ã€‚', stop: true },
            // äº’åŠ¨ (Party - å¥¶é…ªé»„)
            { type: 'party', icon: 'ğŸ“¡', title: 'æˆ˜æœ¯å°é˜ŸæŒ‡ä»¤', desc: 'æ€»éƒ¨å‘æ¥äº†ç‰¹åˆ«çš„è€ƒéªŒä»»åŠ¡ï¼Œå®ŒæˆæŒ‘æˆ˜æ‰èƒ½è·å¾—å¥–åŠ±å“¦ï¼', challenge: true },
            { type: 'party', icon: 'ğŸ²', title: 'å‘½è¿å¤§è½¬ç›˜', desc: 'é¢ä¸´å‘½è¿çš„åˆ†æ­§ç‚¹ï¼Œæ¥å—æœªçŸ¥çš„å®¡åˆ¤å§ï¼', challenge: true }
        ];

        class PartyGame {
            constructor() {
                this.pos = 0;
                this.role = null;
                this.isStopped = false;
                this.isMoving = false;
                this.mapData = [];
                this.nodeCoords = []; 
            }

            start(role) {
                this.role = role;
                const roleData = { 
                    kai: { icon: 'âš”ï¸', name: 'å‡¯Â·æ´›' }, 
                    roy: { icon: 'ğŸ’‰', name: 'ç½—ä¼Š' }, 
                    luna: { icon: 'ğŸ¹', name: 'éœ²å¨œ' } 
                };
                document.getElementById('role-icon').innerText = roleData[role].icon;
                document.getElementById('role-name').innerText = roleData[role].name;
                
                const selectScreen = document.getElementById('char-select');
                selectScreen.style.opacity = 0;
                setTimeout(() => selectScreen.style.display = 'none', 500);
                
                this.generateMap();
                setTimeout(() => this.updateView(0), 200); 
            }

            generateMap() {
                const layer = document.getElementById('map-nodes-layer');
                layer.innerHTML = '';
                this.nodeCoords = [];

                const viewportW = window.innerWidth;
                const viewportH = window.innerHeight;
                const radiusX = viewportW * 0.40; 
                const radiusY = viewportH * 0.32; 
                const startAngle = -90; 

                for(let i=0; i<MAP_STEPS; i++) {
                    let data;
                    if (i === 0) data = { type: 'start', icon: 'ğŸš©', title: 'éƒ¨ç½²ç‚¹', desc: 'Ready Go!' };
                    else if (i === MAP_STEPS - 1) data = { type: 'end', icon: 'ğŸš', title: 'æ’¤ç¦»ç‚¹', desc: 'Win!' };
                    else {
                        const evt = EVENTS[Math.floor(Math.random() * EVENTS.length)];
                        data = { ...evt };
                    }
                    this.mapData.push(data);

                    const angle = startAngle + (i / (MAP_STEPS - 1)) * 360;
                    const radian = angle * (Math.PI / 180);
                    const x = radiusX * Math.cos(radian);
                    const y = radiusY * Math.sin(radian);
                    const finalX = x - 37.5; 
                    const finalY = y - 37.5;
                    this.nodeCoords.push({x: finalX, y: finalY});

                    const el = document.createElement('div');
                    el.className = `map-node`;
                    el.id = `node-${i}`;
                    el.style.transform = `translate(${finalX}px, ${finalY}px)`;

                    const innerHTML = 
                        `<div class="node-card" data-type="${data.type}">
                             <div class="node-icon">${data.icon}</div>
                         </div>
                         <div class="node-text"><h4>${data.title}</h4><p>${data.desc}</p></div>
                         <div class="node-idx">${i}</div>`;

                    el.innerHTML = innerHTML;
                    layer.appendChild(el);
                }
            }

            async roll() {
                // å¦‚æœå·²ç»åˆ°è¾¾ç»ˆç‚¹ï¼Œç¦æ­¢å†æ¬¡æ‘‡éª°å­
                if(this.pos >= MAP_STEPS - 1) return;
                if(this.isMoving) return;
                
                if(this.isStopped) {
                    this.showAlert('stop', 'è¡ŒåŠ¨å—é˜»', 'ä½ è¿˜åœ¨æ™•ä¹ä¹çš„çŠ¶æ€ï¼Œæœ¬å›åˆè·³è¿‡å•¦ã€‚', [{text:'å¥½å§', class:'btn-outline', action:()=>this.closeAlert()}]);
                    this.isStopped = false;
                    return;
                }

                this.isMoving = true;
                const btn = document.getElementById('roll-btn');
                btn.disabled = true;
                btn.innerText = "æ‘‡éª°å­...";

                let step = Math.floor(Math.random() * 6) + 1;
                
                for(let i=0; i<10; i++) {
                    btn.innerText = Math.floor(Math.random() * 6) + 1;
                    await new Promise(r => setTimeout(r, 50));
                }
                btn.innerText = `[ ${step} ]`;
                
                // å‡¯Â·æ´› è¢«åŠ¨
                let extraTurn = false;
                if(this.role === 'kai' && step === 6) {
                    setTimeout(() => {
                        this.showAlert('good', 'å‡¯Â·æ´›å¤©èµ‹è§¦å‘!', 'å“‡ï¼æ·å‡º 6 ç‚¹ï¼å¯ä»¥å¼€å¿ƒåœ°å†åŠ¨ä¸€æ¬¡ï¼', [], true);
                    }, 500);
                    extraTurn = true;
                }

                let target = this.pos + step;
                // æ ¸å¿ƒä¿®æ”¹ï¼šåªè¦ç›®æ ‡å¤§äºç­‰äºç»ˆç‚¹ï¼Œå°±è®¾ç½®ä¸ºç»ˆç‚¹
                if(target >= MAP_STEPS - 1) target = MAP_STEPS - 1;

                await this.animateMove(target);
                await this.triggerEvent();

                if(!extraTurn && this.pos < MAP_STEPS - 1) {
                    btn.innerText = "å‡ºå‘é¸­!";
                    btn.disabled = false;
                    this.isMoving = false;
                } else if (extraTurn && this.pos < MAP_STEPS - 1) {
                    btn.innerText = "å†æ¥ä¸€æ¬¡!";
                    btn.disabled = false;
                    this.isMoving = false;
                }
                // å¦‚æœå·²ç»åœ¨ç»ˆç‚¹ï¼Œä¿æŒæŒ‰é’®ç¦ç”¨å’ŒisMovingçŠ¶æ€ï¼Œé˜²æ­¢é¢å¤–æ“ä½œ
            }

            async animateMove(target) {
                const direction = target > this.pos ? 1 : -1;
                if (this.pos === target) return;

                for(let i = this.pos + direction; direction > 0 ? i <= target : i >= target; i += direction) {
                    this.pos = i;
                    this.updateView(i);
                    // åˆ°è¾¾ç»ˆç‚¹æ—¶ä¸éœ€è¦ç­‰å¾…ï¼Œç›´æ¥è§¦å‘åº†ç¥
                    if (i < MAP_STEPS - 1) {
                        await new Promise(r => setTimeout(r, 400));
                    }
                }
            }

            updateView(idx) {
                const coords = this.nodeCoords[idx];
                const token = document.getElementById('player');
                token.style.transform = `translate(${coords.x}px, ${coords.y}px)`;
                document.getElementById('dist-display').innerText = `${MAP_STEPS - 1 - idx}`;
                document.querySelectorAll('.map-node').forEach(n => n.classList.remove('active'));
                document.getElementById(`node-${idx}`).classList.add('active');
            }

            async triggerEvent() {
                const data = this.mapData[this.pos];
                
                // æ ¸å¿ƒä¿®æ”¹ï¼šèƒœåˆ©æ¡ä»¶åˆ¤æ–­
                if(data.type === 'end') {
                    // é”å®šæ¸¸æˆçŠ¶æ€
                    this.isMoving = true; 
                    const btn = document.getElementById('roll-btn');
                    btn.disabled = true;
                    btn.innerText = "æ¸¸æˆç»“æŸ";
                    
                    this.showAlert('good', 'è¡ŒåŠ¨æˆåŠŸ! ğŸ‰', 'è€¶ï¼æˆåŠŸæŠµè¾¾æ’¤ç¦»ç‚¹ï¼æ˜“æ¡ç”µç«å…¨å‘˜å®‰å…¨æ’¤ç¦»ï¼', [{text:'å†ç©ä¸€æ¬¡', class:'btn-primary', action:()=>location.reload()}]);
                    return;
                }

                if(data.type === 'start') return;

                if(data.challenge) {
                    const ch = CHALLENGES[Math.floor(Math.random() * CHALLENGES.length)];
                    
                    // éœ²å¨œ è¢«åŠ¨
                    let failText = `å¤±è´¥æƒ©ç½šï¼šåé€€ ${Math.abs(ch.fail)} æ ¼`;
                    if(this.role === 'luna') failText = `éœ²å¨œå¤©èµ‹ï¼šä¾¦å¯ŸæŒ‡å¼•è±å…æƒ©ç½š!`;

                    this.showAlert('party', data.title, 
                        `<strong style="color:var(--c-accent); font-size:18px; display:block; margin-bottom:15px;">æŒ‡ä»¤ï¼š${ch.text}</strong>
                        æˆåŠŸå¥–åŠ±ï¼šå‰è¿› ${ch.reward} æ ¼<br>${failText}`, 
                        [
                            { text: 'æ²¡é—®é¢˜! (ç¡®è®¤)', class: 'btn-primary', action: () => { 
                                this.closeAlert(); 
                                this.moveRelative(ch.reward); 
                            }},
                            { text: 'å¤ªéš¾äº†... (æ”¾å¼ƒ)', class: 'btn-danger', action: () => { 
                                this.closeAlert(); 
                                if(this.role !== 'luna') this.moveRelative(ch.fail); 
                            }}
                        ]
                    );
                }
                else if(data.move) {
                    let moveVal = data.move;
                    // ç½—ä¼Š è¢«åŠ¨
                    if(this.role === 'roy' && moveVal < 0) {
                        moveVal = Math.ceil(moveVal / 2);
                        this.showAlert('good', 'ç½—ä¼Šå¤©èµ‹è§¦å‘!', `æˆ˜åœºæ€¥æ•‘ç”Ÿæ•ˆï¼åé€€æ­¥æ•°å‡åŠå•¦ï¼Œä»…åé€€ ${Math.abs(moveVal)} æ ¼ã€‚`, [], true);
                    } else {
                        this.showAlert(moveVal > 0 ? 'good' : 'bad', data.title, data.desc, [], true);
                    }
                    setTimeout(() => this.moveRelative(moveVal), 1500);
                }
                else if(data.stop) {
                    this.isStopped = true;
                    this.showAlert('stop', data.title, data.desc, [], true);
                }
            }

            async moveRelative(steps) {
                let target = this.pos + steps;
                if(target < 0) target = 0;
                // åŒæ ·é€‚ç”¨æ–°çš„èƒœåˆ©è§„åˆ™
                if(target >= MAP_STEPS - 1) target = MAP_STEPS - 1;
                await this.animateMove(target);
            }

            showAlert(theme, title, desc, buttons, autoClose) {
                const layer = document.getElementById('alert-layer');
                const box = document.getElementById('alert-box');
                
                box.setAttribute('data-theme', theme);
                const icons = { party: 'ğŸ“¡', good: 'âœ¨', bad: 'ğŸ’¦', stop: 'ğŸ’«' };
                document.getElementById('a-icon').innerText = icons[theme] || 'âœ¨';
                document.getElementById('a-title').innerText = title;
                document.getElementById('a-title').style.color = `var(--c-${theme === 'stop' ? 'text' : (theme === 'party' ? 'accent' : theme)})`;
                document.getElementById('a-desc').innerHTML = desc;
                
                const btnGroup = document.getElementById('a-btns');
                btnGroup.innerHTML = '';
                
                if(buttons.length > 0) {
                    buttons.forEach(b => {
                        const btn = document.createElement('button');
                        btn.className = `btn ${b.class || 'btn-outline'}`;
                        btn.innerText = b.text;
                        btn.onclick = b.action;
                        btnGroup.appendChild(btn);
                    });
                } else if (!autoClose) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-outline';
                    btn.innerText = 'çŸ¥é“å•¦';
                    btn.onclick = () => this.closeAlert();
                    btnGroup.appendChild(btn);
                }

                layer.classList.add('show');
                if(autoClose) setTimeout(() => this.closeAlert(), 2500);
            }

            closeAlert() {
                document.getElementById('alert-layer').classList.remove('show');
            }
        }

        const game = new PartyGame();

    </script>
</body>
</html>